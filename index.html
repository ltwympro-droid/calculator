<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>єОселя калькулятор</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;padding:20px;background:#f4f6f9;}
.card{background:white;padding:20px;border-radius:12px;max-width:900px;margin:auto;}
.field{margin-bottom:15px;}
label{font-weight:bold;}
input,select{width:100%;padding:8px;margin-top:4px;}
button{padding:10px 15px;margin:5px 0;border:none;background:#2563eb;color:white;border-radius:6px;cursor:pointer;}
.result{margin-top:20px;padding:15px;background:#eef2ff;border-radius:8px;}
</style>
</head>

<body>

<div class="card">

<h2>єОселя калькулятор</h2>

<div class="field">
<label>Ціна квартири</label>
<input type="number" id="price" value="4000000">
</div>

<div class="field">
<label>Перший внесок (%)</label>
<input type="number" id="down" value="25">
</div>

<div class="field">
<label>Термін (років)</label>
<input type="number" id="years" value="20">
</div>

<div class="field">
<label>Ставка</label>
<select id="rate">
<option value="3">3%</option>
<option value="7">7%</option>
</select>
</div>

<button onclick="calculate()">Розрахувати</button>
<button onclick="generatePDF()">Завантажити PDF</button>

<div class="result" id="output"></div>

<canvas id="chart" style="margin-top:20px;"></canvas>

</div>

<script>

let payment1=0;
let payment2=0;
let totalPaid=0;
let overpayment=0;
let loan=0;
let months=0;
let firstPeriod=0;
let rateBase=0;
let rateAfter=0;
let chart;

function annuity(sum,rate,months){
 let r=rate/100/12;
 return sum*(r*Math.pow(1+r,months))/(Math.pow(1+r,months)-1);
}

function remaining(sum,rate,paid,total){
 let r=rate/100/12;
 let p=annuity(sum,rate,total);
 return sum*Math.pow(1+r,paid)-p*((Math.pow(1+r,paid)-1)/r);
}

function calculate(){

 let price=+document.getElementById("price").value;
 let downP=+document.getElementById("down").value;
 let years=+document.getElementById("years").value;
 rateBase=+document.getElementById("rate").value;

 loan=price*(1-downP/100);
 months=years*12;
 firstPeriod=Math.min(120,months);
 rateAfter=rateBase==3?6:10;

 payment1=annuity(loan,rateBase,months);
 let balance=remaining(loan,rateBase,firstPeriod,months);

 if(months>120){
  payment2=annuity(balance,rateAfter,months-120);
 } else {
  payment2=0;
 }

 totalPaid=payment1*firstPeriod+payment2*Math.max(0,months-120);
 overpayment=totalPaid-loan;

 document.getElementById("output").innerHTML=
 `
 Сума кредиту: ${loan.toLocaleString()} грн<br>
 Платіж перші 10 років: ${payment1.toFixed(0)} грн<br>
 Платіж з 11-го року: ${payment2.toFixed(0)} грн<br>
 Загальна сума виплат: ${totalPaid.toFixed(0)} грн<br>
 Переплата: ${overpayment.toFixed(0)} грн
 `;

 drawChart();
}

function drawChart(){

 let data=[];
 for(let i=0;i<months;i++){
  if(i<120) data.push(payment1);
  else data.push(payment2);
 }

 if(chart) chart.destroy();

 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{
   labels:data.map((_,i)=>i+1),
   datasets:[{
    label:"Щомісячний платіж",
    data:data,
    borderColor:"#2563eb",
    fill:false
   }]
  }
 });
}

async function generatePDF(){

 const { jsPDF } = window.jspdf;
 let doc=new jsPDF();

 doc.setFontSize(16);
 doc.text("Звіт по програмі єОселя",20,20);

 doc.setFontSize(12);
 doc.text(`Сума кредиту: ${loan.toFixed(0)} грн`,20,40);
 doc.text(`Платіж перші 10 років: ${payment1.toFixed(0)} грн`,20,50);
 doc.text(`Платіж з 11-го року: ${payment2.toFixed(0)} грн`,20,60);
 doc.text(`Загальна сума виплат: ${totalPaid.toFixed(0)} грн`,20,70);
 doc.text(`Переплата: ${overpayment.toFixed(0)} грн`,20,80);

 let canvas=document.getElementById("chart");
 let img=canvas.toDataURL("image/png",1.0);

 doc.addImage(img,"PNG",15,90,180,80);

 doc.save("YeOselia_Report.pdf");
}

calculate();

</script>

</body>
</html>
