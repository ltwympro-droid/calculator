<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>єОселя калькулятор</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px;}
.card{background:white;padding:20px;border-radius:12px;max-width:1000px;margin:auto;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.field{margin-bottom:15px;}
label{font-weight:bold;}
input,select{width:100%;padding:8px;margin-top:4px;}
button{padding:10px 15px;margin:5px 0;border:none;background:#2563eb;color:white;border-radius:6px;cursor:pointer;}
.result{margin-top:20px;padding:15px;background:#eef2ff;border-radius:8px;}
.admin{margin-top:20px;padding:15px;background:#fff3e0;border-radius:8px;display:none;}
</style>
</head>

<body>

<div class="card">

<h2>єОселя калькулятор</h2>

<div class="grid">
<div>

<div class="field">
<label>Ціна квартири</label>
<input type="number" id="price" value="4000000">
</div>

<div class="field">
<label>Перший внесок (%)</label>
<input type="number" id="down" value="25">
</div>

<div class="field">
<label>Термін (років)</label>
<input type="number" id="years" value="20">
</div>

<div class="field">
<label>Ставка</label>
<select id="rateSel">
<option value="3">3%</option>
<option value="7">7%</option>
</select>
</div>

<button onclick="calculate()">Розрахувати</button>
<button onclick="generateReport()">Завантажити PDF</button>
<button onclick="toggleAdmin()">Адмін</button>

</div>

<div>

<div class="result" id="output"></div>

</div>
</div>

<div class="admin" id="adminBox">
<label>PIN 1357</label>
</div>

</div>

<script>

let lastData={};

function annuity(sum,rate,months){
 const r=rate/100/12;
 return sum*(r*Math.pow(1+r,months))/(Math.pow(1+r,months)-1);
}

function remaining(sum,rate,paid,total){
 const r=rate/100/12;
 const p=annuity(sum,rate,total);
 return sum*Math.pow(1+r,paid)-p*((Math.pow(1+r,paid)-1)/r);
}

function calculate(){

 const price=+document.getElementById("price").value;
 const downP=+document.getElementById("down").value;
 const years=+document.getElementById("years").value;
 const rateBase=+document.getElementById("rateSel").value;

 const loan=price*(1-downP/100);
 const months=years*12;
 const firstMonths=Math.min(120,months);
 const rateAfter=rateBase==3?6:10;

 const pay1=annuity(loan,rateBase,months);
 const balanceAfter10=remaining(loan,rateBase,firstMonths,months);

 let pay2=0;
 if(months>120){
  pay2=annuity(balanceAfter10,rateAfter,months-120);
 }

 const totalPaid=pay1*firstMonths+pay2*Math.max(0,months-120);
 const overpayment=totalPaid-loan;

 lastData={
  price,downP,loan,pay1,pay2,totalPaid,overpayment,months
 };

 document.getElementById("output").innerHTML=
 `
 Сума кредиту: ${loan.toLocaleString()} грн<br>
 Платіж перші 10 років: ${pay1.toFixed(0)} грн<br>
 ${months>120?`Платіж з 11-го року: ${pay2.toFixed(0)} грн<br>`:""}
 Загальна сума виплат: ${totalPaid.toFixed(0)} грн<br>
 Переплата: ${overpayment.toFixed(0)} грн
 `;
}

async function generateReport(){

 if(!lastData.loan){
  alert("Спочатку зробіть розрахунок");
  return;
 }

 const { jsPDF } = window.jspdf;
 const doc=new jsPDF();

 doc.setFontSize(16);
 doc.text("Звіт по програмі єОселя",20,20);

 doc.setFontSize(12);
 doc.text(`Ціна квартири: ${lastData.price.toLocaleString()} грн`,20,35);
 doc.text(`Перший внесок: ${lastData.downP}%`,20,45);
 doc.text(`Сума кредиту: ${lastData.loan.toLocaleString()} грн`,20,55);
 doc.text(`Платіж перші 10 років: ${lastData.pay1.toFixed(0)} грн`,20,70);
 if(lastData.pay2>0)
  doc.text(`Платіж з 11-го року: ${lastData.pay2.toFixed(0)} грн`,20,80);
 doc.text(`Загальна сума виплат: ${lastData.totalPaid.toFixed(0)} грн`,20,95);
 doc.text(`Переплата: ${lastData.overpayment.toFixed(0)} грн`,20,105);

 const canvas=document.createElement("canvas");
 canvas.width=800;
 canvas.height=400;
 const ctx=canvas.getContext("2d");

 const payments=[];
 for(let i=0;i<lastData.months;i++){
  if(i<120) payments.push(lastData.pay1);
  else payments.push(lastData.pay2);
 }

 new Chart(ctx,{
  type:"line",
  data:{
   labels:payments.map((_,i)=>i+1),
   datasets:[{
    label:"Щомісячний платіж",
    data:payments,
    borderColor:"#2563eb",
    fill:false
   }]
  },
  options:{responsive:false}
 });

 await new Promise(r=>setTimeout(r,500));

 const img=canvas.toDataURL("image/png",1.0);
 doc.addPage();
 doc.text("Графік зміни щомісячного платежу",20,20);
 doc.addImage(img,"PNG",15,30,180,90);

 doc.save("YeOselia_Report.pdf");
}

function toggleAdmin(){
 const pin=prompt("Введіть PIN");
 if(pin==="1357"){
  const box=document.getElementById("adminBox");
  box.style.display=box.style.display==="block"?"none":"block";
 }
}

calculate();

</script>

</body>
</html>
