const PROGRAM_LIMIT = 5000000;
const PIN="1357";
let usd=38;

const $=id=>document.getElementById(id);
const fmt=n=>Number(n).toLocaleString("uk-UA");

function toggleTheme(){document.body.classList.toggle("dark");}

function toggleAdmin(){
 const box=$("adminBox");
 if(box.style.display==="block"){
   box.style.display="none";
 }else{
   if(prompt("PIN")==PIN){
     box.style.display="block";
   }
 }
}

async function loadRate(){
 try{
  const r=await fetch("https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json");
  const j=await r.json();
  usd=j[0].rate;
  $("rateBox").innerHTML="USD НБУ: "+usd.toFixed(2);
  calc();
 }catch{}
}

[
"price","area","fam","down","years","rateSel",
"baseM2","coef","extraPct","minDown","bankCap"
].forEach(id=>{
 $(id).addEventListener("input",calc);
 $(id).addEventListener("change",calc);
});

function calc(){

 const price=+$("price").value;
 const area=+$("area").value;
 const fam=+$("fam").value;
 const downP=+$("down").value;
 const years=+$("years").value;
 const rate=+$("rateSel").value;
 const cap=+$("bankCap").value;

 const base=+$("baseM2").value;
 const coef=+$("coef").value;
 const extra=+$("extraPct").value/100;
 const minDown=+$("minDown").value;

 const norm=fam<=2?52.5:52.5+(fam-2)*21;
 const maxArea=Math.min(norm*(1+extra),115.5);
 const limitM2=base*coef*(1+extra);
 const maxPrice=limitM2*norm;

 const downSum=price*downP/100;
 const loan=price-downSum;

 const mr=rate/100/12;
 const pay=loan*(mr*Math.pow(1+mr,years*12))/
           (Math.pow(1+mr,years*12)-1);

 let reasons=[];
 let solutions=[];

 if(price>maxPrice){
  reasons.push("Перевищена максимальна допустима ціна квартири.");
  solutions.push("Максимально допустима ціна: "+fmt(maxPrice.toFixed(0))+" грн.");
 }

 if(area>maxArea){
  reasons.push("Площа перевищує норматив для складу сім'ї.");
  solutions.push("Максимально допустима площа: "+maxArea.toFixed(1)+" м².");
 }

 if(loan>PROGRAM_LIMIT){
  reasons.push("Сума кредиту перевищує ліміт програми (5 000 000 грн).");
 }

 if(loan>cap){
  reasons.push("Сума кредиту перевищує ліміт банку.");
 }

 if(downP<minDown){
  reasons.push("Перший внесок менший за мінімально допустимий.");
 }

 if(loan>cap || loan>PROGRAM_LIMIT){
   const minDownNeeded = price - Math.min(cap,PROGRAM_LIMIT);
   solutions.push("Мінімальний перший внесок має бути ≈ "+fmt(minDownNeeded.toFixed(0))+" грн.");
 }

 const fit=reasons.length===0;

 $("priceVal").innerHTML=fmt(price);
 $("areaVal").innerHTML=area+" м²";
 $("famVal").innerHTML=fam;
 $("downVal").innerHTML=downP+"%";
 $("yearsVal").innerHTML=years+" років";

 $("out").innerHTML=`
 <div class="status ${fit?'success':'error'}">
 ${fit?'✅ Клієнт проходить':'❌ Клієнт не проходить'}
 </div>

 <strong>Розрахунок:</strong><br><br>

 Ціна: ${fmt(price)} грн (~$${fmt((price/usd).toFixed(0))})<br>
 Перший внесок: ${fmt(downSum)} грн<br>
 Сума кредиту: ${fmt(loan)} грн<br>
 Щомісячний платіж: <strong>${fmt(pay.toFixed(0))} грн</strong><br><br>

 ${!fit?`
 <strong>Причини:</strong><br>
 ${reasons.map(r=>"• "+r).join("<br>")}<br><br>
 <strong>Що можна зробити:</strong><br>
 ${solutions.map(s=>"• "+s).join("<br>")}
 `:""}
 `;
}

calc();
